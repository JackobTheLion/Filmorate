CREATE TABLE filmorate_users
(
    user_id  integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email    varchar(50) UNIQUE,
    login    varchar(50) UNIQUE,
    name     varchar(50),
    birthday date
);

CREATE TABLE mpa
(
    mpa_id Integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    mpa    varchar(50)
);

CREATE TABLE films
(
    film_id      integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name         varchar(50),
    description  varchar(255),
    release_date date,
    duration     integer,
    mpa_id       Integer REFERENCES mpa (mpa_id) ON DELETE CASCADE
);

CREATE TABLE likes
(
    like_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    film_id integer REFERENCES films (film_id) ON DELETE CASCADE,
    user_id integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE
);

CREATE TABLE genre
(
    genre_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name     varchar(50)
);

CREATE TABLE film_genre
(
    film_id  integer REFERENCES films (film_id) ON DELETE CASCADE,
    genre_id integer REFERENCES genre (genre_id) ON DELETE CASCADE,
    PRIMARY KEY (film_id, genre_id)
);

CREATE TABLE friends
(
    friendship_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user1_id  integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE,
    user2_id  integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE,
    confirmed boolean DEFAULT false
);

CREATE TABLE reviews
(
    review_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
);

CREATE TABLE like_event
(
    event_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp timestamp DEFAULT NOW(),
    user_id integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE,
    eventType ENUM ('LIKE', 'REVIEW', 'FRIEND') DEFAULT 'LIKE',
    operation ENUM ('REMOVE', 'ADD', 'UPDATE'),
    like_id integer REFERENCES likes (like_id) ON DELETE CASCADE
);

CREATE TABLE review_event
(
    event_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp timestamp DEFAULT NOW(),
    user_id integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE,
    eventType ENUM ('LIKE', 'REVIEW', 'FRIEND') DEFAULT 'REVIEW',
    operation ENUM ('REMOVE', 'ADD', 'UPDATE'),
    review_id integer REFERENCES reviews (review_id) ON DELETE CASCADE
);

CREATE TABLE friend_event
(
    event_id integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    timestamp timestamp DEFAULT NOW(),
    user_id integer REFERENCES filmorate_users (user_id) ON DELETE CASCADE,
    eventType ENUM ('LIKE', 'REVIEW', 'FRIEND') DEFAULT 'FRIEND',
    operation ENUM ('REMOVE', 'ADD', 'UPDATE'),
    friendship_id integer REFERENCES friends (friendship_id) ON DELETE CASCADE
);

ALTER TABLE friends ADD CONSTRAINT uniqe_friends UNIQUE (user1_id, user2_id);

ALTER TABLE likes ADD CONSTRAINT uniqe_like UNIQUE (film_id, user_id);